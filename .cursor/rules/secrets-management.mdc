---
description: Rules for adding new external API integrations, managing Cloudflare Worker secrets, and creating bot skills in the moltworker project.
globs:
  - src/types.ts
  - src/gateway/env.ts
  - start-moltbot.sh
  - wrangler.jsonc
  - skills/**/*.md
alwaysApply: false
---

# Moltworker API Integration & Secrets Management

## Before Writing Any Code (New API Integration)

1. **Read the official API docs** — find the real base URL, auth format, required headers
2. **Verify the domain** — run `nslookup <domain>` to confirm it exists (we've been burned by non-existent domains like `api.publer.io` when the real URL was `app.publer.com`)
3. **Test locally** — run a `curl` from your machine before touching the bot
4. **Copy URLs from docs** — never guess or remember API base URLs
5. **Include a smoke test** in the skill file so the bot can self-verify

## Two Approaches for API Secrets

### Option A: Direct to Bot via Telegram (Bot-Only Secrets)

If the secret is **only used by the bot** (not the Worker), message Hoss directly
via Telegram with the credentials. He stores them in his workspace, which gets
backed up to R2 every 5 minutes and survives container restarts.

**Use for:** API keys the bot calls via `curl` (X Access Token, Publer key, etc.)
**Pros:** Immediate, no deploy, no code changes.

### Option B: Cloudflare Secrets Pipeline (Worker + Bot Secrets)

If the secret is needed by **the Worker** code (referenced in `env.*`), use the full
pipeline below.

**Use for:** Infrastructure secrets (Anthropic API key, Telegram bot token, CF Access).

## Deployment Command

**ALWAYS use `npm run deploy`** — NEVER `npx wrangler deploy` directly.
`npm run deploy` runs `npm run build && wrangler deploy`, which compiles TypeScript first.
Using `npx wrangler deploy` skips the build step and deploys stale code.

## Adding a New Secret via Cloudflare Pipeline (Option B)

There are **5 files** to update and **2 CLI commands** to run. All are required.

### Files (in order)

1. `src/types.ts` — Add to `MoltbotEnv` interface
2. `src/gateway/env.ts` — Add to BOTH `buildEnvVars()` AND `getEnvFingerprint()`
3. `start-moltbot.sh` — Add to logging section AND to the `/tmp/.api-env` heredoc
4. `wrangler.jsonc` — Add comment documenting the secret
5. `skills/<name>/SKILL.md` — Include `source /tmp/.api-env` before API calls

### CLI Commands

```bash
npx wrangler secret put NEW_KEY_NAME   # Interactive prompt - paste value
npm run deploy                          # Build + deploy
```

### Critical Details

- The heredoc in `start-moltbot.sh` that writes `/tmp/.api-env` must use an **UNQUOTED** delimiter (`<< ENVEOF` not `<< 'ENVEOF'`) for shell variable expansion
- Bot skills must `source /tmp/.api-env` before using API env vars because OpenClaw exec sessions do not inherit the gateway process environment
- The env fingerprint mechanism in `process.ts` auto-detects when new secrets are added and restarts the container process
- The fingerprint only tracks key **names**, not values — changing a value without adding/removing keys requires a cache bust bump in the Dockerfile to force a container restart
- After deploy, wait ~90 seconds for the new container to boot

## Debugging Secrets

- `npx wrangler secret list` — Shows names only (values are encrypted)
- `npx wrangler tail` — Live logs (WARNING: exposes secret values in plaintext via setEnvVars logging)
- Check `AGENTS.md` "Adding a New API Secret" section for the full troubleshooting table

## Common Mistakes

- Using `npx wrangler deploy` instead of `npm run deploy` (skips TypeScript build)
- Forgetting to add to `getEnvFingerprint()` (container won't restart to pick up new secret)
- Using a quoted heredoc in `start-moltbot.sh` (writes literal `${VAR}` instead of the value)
- Forgetting to `source /tmp/.api-env` in bot skill files
- Setting a secret **value** to the key **name** instead of the actual value (e.g., setting PUBLER_WORKSPACE_ID to "hoss-api-key" instead of the real workspace ID)
- Changing only a secret's **value** (not adding/removing keys) won't trigger the env fingerprint restart — bump the Dockerfile CACHE_BUST to force it
