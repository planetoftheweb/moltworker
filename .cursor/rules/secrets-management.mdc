---
description: Rules for adding, updating, or debugging Cloudflare Worker secrets and API keys in the moltworker project.
globs:
  - src/types.ts
  - src/gateway/env.ts
  - start-moltbot.sh
  - wrangler.jsonc
  - skills/**/*.md
alwaysApply: false
---

# Moltworker Secrets Management

## Deployment Command

**ALWAYS use `npm run deploy`** — NEVER `npx wrangler deploy` directly.
`npm run deploy` runs `npm run build && wrangler deploy`, which compiles TypeScript first.
Using `npx wrangler deploy` skips the build step and deploys stale code.

## Adding a New API Secret

There are **5 files** to update and **2 CLI commands** to run. All are required.

### Files (in order)

1. `src/types.ts` — Add to `MoltbotEnv` interface
2. `src/gateway/env.ts` — Add to BOTH `buildEnvVars()` AND `getEnvFingerprint()`
3. `start-moltbot.sh` — Add to logging section AND to the `/tmp/.api-env` heredoc
4. `wrangler.jsonc` — Add comment documenting the secret
5. `skills/<name>/SKILL.md` — Include `source /tmp/.api-env` before API calls

### CLI Commands

```bash
npx wrangler secret put NEW_KEY_NAME   # Interactive prompt - paste value
npm run deploy                          # Build + deploy
```

### Critical Details

- The heredoc in `start-moltbot.sh` that writes `/tmp/.api-env` must use an **UNQUOTED** delimiter (`<< ENVEOF` not `<< 'ENVEOF'`) for shell variable expansion
- Bot skills must `source /tmp/.api-env` before using API env vars because OpenClaw exec sessions do not inherit the gateway process environment
- The env fingerprint mechanism in `process.ts` auto-detects when new secrets are added and restarts the container process
- After deploy, wait ~90 seconds for the new container to boot

## Debugging Secrets

- `npx wrangler secret list` — Shows names only (values are encrypted)
- `npx wrangler tail` — Live logs (WARNING: exposes secret values in plaintext via setEnvVars logging)
- Check `AGENTS.md` "Adding a New API Secret" section for the full troubleshooting table

## Common Mistakes

- Using `npx wrangler deploy` instead of `npm run deploy` (skips TypeScript build)
- Forgetting to add to `getEnvFingerprint()` (container won't restart to pick up new secret)
- Using a quoted heredoc in `start-moltbot.sh` (writes literal `${VAR}` instead of the value)
- Forgetting to `source /tmp/.api-env` in bot skill files
